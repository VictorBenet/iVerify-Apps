# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript
# npm install
# npm run build

trigger:
- master

pool:
  vmImage: ubuntu-latest

steps:
- task: NodeTool@0
  inputs:
    versionSpec: '12.x'
  displayName: 'Install Node.js'

- script: |
    npm install
    npx nx run-many --target=deploy --projects=publisher,api,triage --parallel
    docker-compose up -d
  displayName: 'npm install and build, build and run docker containers'
- task: Kubernetes@1
  inputs:
    connectionType: 'Kubernetes Service Connection'
    kubernetesServiceEndpoint: 'Production-JS-undphq10aks001-default-1624549054528'
    command: 
    secretType: 'dockerRegistry'
    containerRegistryType: 'Azure Container Registry'